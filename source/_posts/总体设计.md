---
title: 总体设计
date: 2023-9-19 15:15:17
excerpt: 从零开始的编译器之总体设计
categories: [技术, 编译技术]
tags: [编译器设计]
topic: compiler
---

# 总体设计

## 前言

本次的编译器实现我准备采用`Java`语言来写，主要有三个方面的考虑：

1. 之前上过JAVA-OOP，对java的语法和面向对象编程的机制都更加熟悉。
2. 因为我是Mac和Win双持用户，再加上考试的时候的评测机的C艹编译器也捉摸不定，想统一环境实在有些困难，此时Java虚拟机的优势就显现的非常明显了。
3. 小伙伴们都用的Java，方便交流讨论。

确定了语言之后，就可以~~快乐的~~开始写代码了！

## Javac介绍

考虑到之后还会有很多新需求，无论如何可能都没有办法避免重构，所以其实一开始也不用设计的太好啦！

但是为了能减少以后的工作量，一定程度的设计也是要有的。我没有按照课程组的推荐去参考pascals和pl0的编译器——太古老了。这从1989流传至今，甚至是用word文档保存的代码，看得人头疼。

因此，我挑挑选选，决定参考`javac`的源代码。

主要有两个优势：

1. GitHub上有现成的源码，查看非常方便。
2. javac的源码是用Java语言写的，非常适合我学习借鉴；同时Java语言本身与C也比较相似，没有很大的迁移成本。

### Javac结构初探

源码在这里可以找到：https://github.com/openjdk/jdk/tree/master/src/jdk.compiler/share/classes/com/sun/tools/javac

这里是一篇有用的笔记：http://47.100.139.123/blog/article/26

由于Java本身的复杂性，可想而知Javac也一定是一个非常非常复杂的系统。因此在看代码的过程中，我们必须化繁为简，只去看有用的和大致的骨架，方可不迷失在巨大的代码仓库中～

因此，我选择先通过编译的几个阶段划分+参考一些博客，大致确定每个阶段都有哪些部分在发挥作用，然后再去针对性地阅读对应的代码，以给我自己的编译器设计一些insights。

具体来说，在进行词法分析时，我针对性地寻找Tokenizer类，发现Tokenizer类中使用了Scanner类，又再去理解Scanner的作用和结构……

## 总体结构

稍微阅读了一些源码，再结合一些前辈的经验，我写的简化版架构如下：

```
-MyCompiler
  - Frontend
    - exception
    	-SysException.java
    - Factory.java
    - Tokens.java
    - Tokenizer.java
    - Scanner.java
  - Backend
  - Compiler.java
```

其中：

- `Compiler.java` 负责编译器的主体任务，包括初始化，启动和销毁。
- `Frontend`包负责前端工作，当然就包括本次的词法分析。
  - `Tokens.java`负责声明所有的Token。
  - `Tokenizer.java`负责做词法分析。
  - `Scanner.java`是为以后预留的类，方便后续的工作。
  - `Factory.java`负责产生和提供Tokenizer、Scanner、Tokens等类的实例，保证单例。
  - `exception`包里声明可能出现的异常。
- `Backend`包负责后端工作，目前是个摆设。

以后如果需要的话，还可以加入`Midend`中端来进行桥接。

## 接口设计

因为这里还是初步设计架构，因此目前需要实现的只有`Compiler`和`Factory`两个类。

### Compiler

`Compiler.java` 是程序的入口，在这里设置输出文件，并安排编译器整体的运行情况。

```java
public class Compiler {
    private static final String input = "testfile.txt";
    private static final String output = "error.txt";

    public static void main(String[] args) throws IOException, SysYException {

        //初始化
      	//词法分析
      	//语法分析
      	//...

    }
}
```

### Factory

Factory是工厂类，作用是初始化并产生单例实体以供其他类调用。

```java
public class Factory {
  	private Tokens tokens;
    private Tokenizer tokenizer;
    private Scanner scanner;
    private Parser parser;

    public void initCompiler(BufferedReader bufferedReader, BufferedWriter bufferedWriter) {
        scanner = new Scanner(bufferedWriter);
        tokens = new Tokens();
        tokenizer = new Tokenizer(tokens, scanner, bufferedReader);
        parser = new Parser(scanner, exceptionHandler, bufferedWriter);
    }

    public Tokenizer getTokenizer() {
        return tokenizer;
    }

    public Parser getParser(){
      return parser;
    }

    public Scanner getScanner() {
        return scanner;
    }

    public Tokens getTokens() {
        return tokens;
    }
  	//...
}

```

